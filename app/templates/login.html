{% extends "base.html" %}

{% block title %}ãƒ­ã‚°ã‚¤ãƒ³ - Firebase Auth App{% endblock %}

{% block extra_head %}
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
{% endblock %}

{% block content %}
<h1>ğŸ” ãƒ­ã‚°ã‚¤ãƒ³</h1>

<div id="error-message" class="error" style="display: none;"></div>

<div id="loading" class="loading">
    <div class="spinner"></div>
    <p style="margin-top: 10px; color: #666;">èªè¨¼ä¸­...</p>
</div>

<form id="login-form">
    <div class="form-group">
        <label for="email">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
        <input type="email" id="email" name="email" required placeholder="example@email.com">
    </div>
    <div class="form-group">
        <label for="password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
        <input type="password" id="password" name="password" required placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
    </div>
    <button type="submit" class="btn btn-primary">ãƒ­ã‚°ã‚¤ãƒ³</button>
</form>

<div class="divider">ã¾ãŸã¯</div>

<button id="register-btn" class="btn btn-secondary">æ–°è¦ç™»éŒ²</button>
{% endblock %}

{% block extra_scripts %}
<script>
    // Firebaseè¨­å®š
    const firebaseConfig = {
        apiKey: "{{ firebase_api_key }}",
        authDomain: "fir-auth-app-5db66.firebaseapp.com",
        projectId: "fir-auth-app-5db66",
        storageBucket: "fir-auth-app-5db66.firebasestorage.app",
        messagingSenderId: "505869037520",
        appId: "1:505869037520:web:33078404c2250661b953d5",
        measurementId: "G-F8BT2PM0N3"
    };

    // FirebaseåˆæœŸåŒ–
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    const loginForm = document.getElementById('login-form');
    const registerBtn = document.getElementById('register-btn');
    const errorMessage = document.getElementById('error-message');
    const loading = document.getElementById('loading');

    function showError(message) {
        errorMessage.textContent = message;
        errorMessage.style.display = 'block';
    }

    function hideError() {
        errorMessage.style.display = 'none';
    }

    function showLoading() {
        loading.classList.add('active');
        loginForm.style.display = 'none';
        registerBtn.style.display = 'none';
    }

    function hideLoading() {
        loading.classList.remove('active');
        loginForm.style.display = 'block';
        registerBtn.style.display = 'block';
    }

    async function sendTokenToServer(idToken) {
        const formData = new FormData();
        formData.append('id_token', idToken);

        const response = await fetch('/auth/login', {
            method: 'POST',
            body: formData,
        });

        if (response.ok) {
            const redirectUrl = response.headers.get('HX-Redirect');
            if (redirectUrl) {
                window.location.href = redirectUrl;
            }
        } else {
            const data = await response.json();
            throw new Error(data.detail || 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        }
    }

    // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        hideError();
        showLoading();

        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;

        try {
            const userCredential = await auth.signInWithEmailAndPassword(email, password);
            const idToken = await userCredential.user.getIdToken();
            await sendTokenToServer(idToken);
        } catch (error) {
            hideLoading();
            console.error('Login error:', error);

            let message = 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ';
            switch (error.code) {
                case 'auth/user-not-found':
                    message = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
                    break;
                case 'auth/wrong-password':
                    message = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“';
                    break;
                case 'auth/invalid-email':
                    message = 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“';
                    break;
                case 'auth/too-many-requests':
                    message = 'ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œå›æ•°ãŒå¤šã™ãã¾ã™ã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰ãŠè©¦ã—ãã ã•ã„';
                    break;
            }
            showError(error.message || message);
        }
    });

    // æ–°è¦ç™»éŒ²å‡¦ç†
    registerBtn.addEventListener('click', async () => {
        hideError();

        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;

        if (!email || !password) {
            showError('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }

        if (password.length < 6) {
            showError('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }

        showLoading();

        try {
            const userCredential = await auth.createUserWithEmailAndPassword(email, password);
            const idToken = await userCredential.user.getIdToken();
            await sendTokenToServer(idToken);
        } catch (error) {
            hideLoading();
            console.error('Register error:', error);

            let message = 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ';
            switch (error.code) {
                case 'auth/email-already-in-use':
                    message = 'ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™';
                    break;
                case 'auth/weak-password':
                    message = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¼±ã™ãã¾ã™';
                    break;
                case 'auth/invalid-email':
                    message = 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“';
                    break;
            }
            showError(error.message || message);
        }
    });
</script>
{% endblock %}ï¿¥